rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================

    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verificar si el usuario es el dueño del documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Obtener datos del usuario
    function getUserData() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
    }

    // Verificar si el usuario tiene un rol específico
    function hasRole(role) {
      return isAuthenticated() && getUserData().rol == role;
    }

    // Verificar si el usuario es admin
    function isAdmin() {
      return hasRole('admin');
    }

    // Verificar si el usuario es host
    function isHost() {
      return hasRole('host');
    }

    // Verificar si el usuario es admin o host
    function isAdminOrHost() {
      return isAdmin() || isHost();
    }

    // ============================================
    // COLECCIÓN: USUARIOS
    // ============================================

    match /usuarios/{userId} {
      // Leer: Usuario puede leer su propio perfil, admin puede leer todos
      allow read: if isOwner(userId) || isAdmin();

      // Crear: Solo durante el registro (desde auth)
      allow create: if isAuthenticated() && isOwner(userId);

      // Actualizar: Usuario puede actualizar su perfil, admin puede actualizar cualquiera
      allow update: if isOwner(userId) || isAdmin();

      // Eliminar: Solo admin
      allow delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: EVENTOS
    // ============================================

    match /eventos/{eventoId} {
      // Leer: Todos pueden leer eventos publicados, admin/host pueden leer todos
      allow read: if resource.data.estado == 'publicado' || isAdminOrHost();

      // Crear: Solo admin
      allow create: if isAdmin();

      // Actualizar: Solo admin
      allow update: if isAdmin();

      // Eliminar: Solo admin
      allow delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: VENUES
    // ============================================

    match /venues/{venueId} {
      // Leer: Todos pueden leer
      allow read: if true;

      // Crear/Actualizar/Eliminar: Solo admin
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: ORDENES
    // ============================================

    match /ordenes/{ordenId} {
      // Leer: Usuario puede leer sus propias órdenes, admin/host pueden leer todas
      allow read: if isOwner(resource.data.userId) || isAdminOrHost();

      // Crear: Usuario autenticado puede crear su propia orden
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Actualizar: Solo admin y host (para cambiar estado)
      allow update: if isAdminOrHost();

      // Eliminar: Solo admin
      allow delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: TICKETS
    // ============================================

    match /tickets/{ticketId} {
      // Leer: Usuario puede leer sus tickets (via ordenId), admin/host pueden leer todos
      allow read: if isAuthenticated() || isAdminOrHost();

      // Crear: Sistema (via orden)
      allow create: if isAuthenticated();

      // Actualizar: Host puede marcar como usado, admin puede actualizar
      allow update: if isAdminOrHost();

      // Eliminar: Solo admin
      allow delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: CÓDIGOS DE DESCUENTO
    // ============================================

    match /codigos-descuento/{codigoId} {
      // Leer: Todos los autenticados
      allow read: if isAuthenticated();

      // Crear/Actualizar/Eliminar: Solo admin
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: SUCURSALES
    // ============================================

    match /sucursales/{sucursalId} {
      // Leer: Todos pueden leer sucursales activas
      allow read: if resource.data.activo == true || isAdminOrHost();

      // Crear/Actualizar/Eliminar: Solo admin
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: RESERVAS
    // ============================================

    match /reservas/{reservaId} {
      // Leer: Usuario puede leer sus reservas, admin/host pueden leer todas
      allow read: if isOwner(resource.data.userId) || isAdminOrHost();

      // Crear: Usuario autenticado puede crear su propia reserva
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Actualizar: Usuario puede modificar su reserva, admin/host pueden actualizar cualquiera
      allow update: if isOwner(resource.data.userId) || isAdminOrHost();

      // Eliminar: Usuario puede cancelar su reserva, admin puede eliminar
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // ============================================
    // COLECCIÓN: MESAS
    // ============================================

    match /mesas/{mesaId} {
      // Leer: Todos los autenticados
      allow read: if isAuthenticated();

      // Crear/Actualizar/Eliminar: Solo admin
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: PLANOS
    // ============================================

    match /planos/{planoId} {
      // Leer: Todos los autenticados
      allow read: if isAuthenticated();

      // Crear/Actualizar/Eliminar: Solo admin
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // COLECCIÓN: LISTA DE ESPERA
    // ============================================

    match /lista-espera/{entradaId} {
      // Leer: Admin y host
      allow read: if isAdminOrHost();

      // Crear: Host puede agregar a lista de espera
      allow create: if isAdminOrHost();

      // Actualizar: Host puede actualizar
      allow update: if isAdminOrHost();

      // Eliminar: Admin y host
      allow delete: if isAdminOrHost();
    }

    // ============================================
    // DENEGAR TODO LO DEMÁS
    // ============================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
